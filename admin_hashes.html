<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Gerar Hashes de Membros (Protegido)</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <!-- SheetJS para ler XLSX no navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <style>
    :root{--bg1:#05060a;--bg2:#0b0f14;--muted:#9aa6b2;--card:rgba(255,255,255,0.03);--stroke:rgba(255,255,255,0.06);--brand:#1f6feb}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef6;margin:0}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    .card{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--stroke)}
    .muted{color:var(--muted)}
    input[type=file]{color:transparent}
    .btn{background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:700}
    .ghost{background:transparent;border:1px solid var(--stroke)}
    pre{white-space:pre-wrap;color:#cfe8ff}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Gate de autenticação -->
  <div id="gate" class="min-h-screen flex items-center justify-center">
    <div class="card w-[min(92%,420px)]">
      <div class="flex items-center gap-3 mb-4">
        <img src="logo-principal.png" alt="logo" class="h-10 object-contain">
        <div>
          <h1 class="text-lg font-bold m-0">Área Restrita — Administração</h1>
          <p class="muted m-0">Acesse com seu e‑mail e senha de administrador.</p>
        </div>
      </div>

      <div class="space-y-3">
        <label class="block">
          <span class="muted text-sm">E‑mail</span>
          <input id="email" type="email" class="w-full mt-1 bg-transparent border border-[color:var(--stroke)] rounded-lg p-2" placeholder="admin@seudominio.com" autocomplete="username">
        </label>
        <label class="block">
          <span class="muted text-sm">Senha</span>
          <input id="password" type="password" class="w-full mt-1 bg-transparent border border-[color:var(--stroke)] rounded-lg p-2" placeholder="••••••••" autocomplete="current-password">
        </label>
        <button id="loginBtn" class="btn w-full">Entrar</button>
        <p id="gateMsg" class="text-sm text-red-300"></p>
        <p class="muted text-xs">Dica: o hash é calculado como <code>SHA‑256(email + senha)</code>. O arquivo permitido deve estar em <code>hashes_administradores.json</code>.</p>
      </div>
    </div>
  </div>

  <!-- App protegido -->
  <div id="app" class="container hidden">
    <header class="flex items-center gap-3 mb-3">
      <img src="logo-principal.png" alt="logo" class="h-12 object-contain">
      <div class="flex-1">
        <h2 class="text-xl font-bold m-0">Admin — Gerar Hashes de Membros</h2>
        <p class="muted m-0">Importe planilha (.xlsx/.xls/.csv) com e‑mail e inscrição/senha, gere <span class="font-semibold">SHA‑256(email+inscrição)</span> ou <span class="font-semibold">SHA‑256(email+senha)</span> e baixe o JSON para os alunos.</p>
      </div>
      <button id="logoutBtn" class="ghost rounded-lg px-3 py-2">Sair</button>
    </header>

    <div class="card">
      <div class="flex gap-3 flex-wrap">
        <label class="ghost px-3 py-2 cursor-pointer">
          Importar planilha
          <input id="file-sheet" type="file" accept=".xlsx,.xls,.csv" class="hidden">
        </label>

        <label class="ghost px-3 py-2 cursor-pointer">
          Importar JSON existente (opcional)
          <input id="file-json" type="file" accept="application/json" class="hidden">
        </label>

        <div class="flex items-center gap-2">
          <label class="muted" for="mode">Modo</label>
          <select id="mode" class="bg-transparent border border-[color:var(--stroke)] text-[color:#e6eef6] px-2 py-1 rounded-md">
            <option value="inscricao">email + inscrição (padrão)</option>
            <option value="senha">email + senha</option>
          </select>
        </div>

        <button id="generate" class="btn">Gerar hashes</button>
        <button id="download" class="btn hidden">Baixar JSON</button>
      </div>

      <hr class="my-3 border-[color:rgba(255,255,255,0.04)]">

      <div class="flex gap-3 flex-wrap">
        <div class="flex-1 min-w-[280px]">
          <h3 class="m-0 mb-2 font-semibold">Resumo</h3>
          <p class="muted" id="summary">Nenhuma planilha carregada.</p>
          <p class="muted">Mapeamento de colunas detectadas (ajuste se necessário):</p>
          <div id="columns" class="mt-2"></div>
        </div>

        <div class="flex-1 min-w-[300px]">
          <h3 class="m-0 mb-2 font-semibold">Preview (primeiros 20 hashes)</h3>
          <pre id="preview">—</pre>
        </div>
      </div>
      <p class="muted mt-3">Ao clicar em <strong>Baixar JSON</strong> você obterá um arquivo que pode substituir/mesclar com <code>hashes_membros.json</code> no repositório.</p>
    </div>
  </div>

  <script>
    // ===== Utilidades =====
    function show(id){ document.getElementById(id).classList.remove('hidden'); }
    function hide(id){ document.getElementById(id).classList.add('hidden'); }

    async function sha256Hex(message){
      const enc = new TextEncoder();
      const data = enc.encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ===== Gate simples de autenticação no front =====
    const ADMIN_HASH_LIST_URL = 'hashes_administradores.json'; // ajuste o caminho se necessário

    async function fetchAdminHashes(){
      try{
        const res = await fetch(ADMIN_HASH_LIST_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(Array.isArray(data)) return data; // formato simples ["hash1","hash2"]
        if(Array.isArray(data.validAdmins)) return data.validAdmins.map(v => v.hash);
        if(Array.isArray(data.validHashes)) return data.validHashes; // compat.
        return [];
      }catch(e){
        console.error('Falha ao carregar lista de admins:', e);
        return [];
      }
    }

    async function tryAutoLogin(){
      const saved = localStorage.getItem('admin_auth_hash');
      if(!saved) return false;
      const list = await fetchAdminHashes();
      const ok = list.includes(saved);
      if(ok){ hide('gate'); show('app'); }
      return ok;
    }

    async function doLogin(){
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pass  = document.getElementById('password').value;
      const msgEl = document.getElementById('gateMsg');
      msgEl.textContent = '';
      if(!email || !pass){ msgEl.textContent = 'Informe e‑mail e senha.'; return; }
      const candidate = await sha256Hex(email + pass);
      const list = await fetchAdminHashes();
      if(list.includes(candidate)){
        localStorage.setItem('admin_auth_hash', candidate);
        hide('gate'); show('app');
      }else{
        msgEl.textContent = 'Credenciais inválidas.';
      }
    }

    function doLogout(){
      localStorage.removeItem('admin_auth_hash');
      location.reload();
    }

    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('logoutBtn').addEventListener('click', doLogout);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !document.getElementById('app').classList.contains('hidden')) return; if(e.key==='Enter') doLogin(); });

    // Tenta SSO local por hash salvo
    tryAutoLogin();

    // ====== App original (gerador de hashes para alunos) ======
    let sheetData = [];
    let detected = { email: null, inscricao: null, senha: null, combined: null };
    let mergedHashes = [];

    const fileSheet = document.getElementById('file-sheet');
    const fileJSON  = document.getElementById('file-json');
    const summary   = document.getElementById('summary');
    const columnsDiv= document.getElementById('columns');
    const preview   = document.getElementById('preview');
    const generateBtn = document.getElementById('generate');
    const downloadBtn = document.getElementById('download');
    const modeSelect  = document.getElementById('mode');

    fileSheet?.addEventListener('change', async (ev) => {
      const f = ev.target.files[0];
      if(!f) return;
      summary.textContent = 'Carregando...';
      sheetData = [];
      try{
        const arrayBuffer = await f.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
        sheetData = json;
        summary.textContent = `Linhas lidas: ${json.length}`;
        detectColumns(json);
      }catch(e){
        console.error(e);
        summary.textContent = 'Falha ao ler a planilha: ' + e.message;
      }
    });

    fileJSON?.addEventListener('change', async (ev) => {
      const f = ev.target.files[0];
      if(!f) return;
      try{
        const text = await f.text();
        const data = JSON.parse(text);
        if(Array.isArray(data)) mergedHashes = data.slice();
        else if (Array.isArray(data.validHashes)) mergedHashes = data.validHashes.slice();
        else mergedHashes = [];
        summary.textContent = `JSON carregado: ${mergedHashes.length} hashes`;
      }catch(e){
        console.error(e);
        summary.textContent = 'Falha ao ler JSON: ' + e.message;
      }
    });

    function detectColumns(json){
      detected = { email: null, inscricao: null, senha: null, combined: null };
      if(!json || json.length===0){ columnsDiv.innerHTML='—'; return; }
      const keys = Object.keys(json[0]);
      for(const k of keys){
        const lower = k.toLowerCase();
        if(!detected.email && lower.includes('email')) detected.email = k;
        if(!detected.inscricao && (lower.includes('inscr') || lower.includes('inscrição') || lower.includes('inscricao'))) detected.inscricao = k;
        if(!detected.senha && lower.includes('senha')) detected.senha = k;
      }
      for(const k of keys){
        const lower = k.toLowerCase();
        if(!detected.inscricao && (lower.includes('id') || lower.includes('matricula') || lower.includes('número') || lower.includes('numero'))) detected.inscricao = k;
      }
      columnsDiv.innerHTML = '';
      for(const k of keys){
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center mb-1.5';
        const label = document.createElement('div'); label.textContent = k; label.className = 'flex-1';
        const select = document.createElement('select');
        select.className = 'bg-transparent border border-[color:var(--stroke)] text-[color:#e6eef6] px-2 py-1 rounded-md';
        select.innerHTML = `<option value="">-- ignorar --</option><option value="email">email</option><option value="inscricao">inscricao</option><option value="senha">senha</option><option value="combined">email + inscrição (coluna única)</option>`;
        select.value = (detected.email===k? 'email' : (detected.inscricao===k? 'inscricao' : (detected.senha===k? 'senha' : '')));
        select.addEventListener('change', ()=>{
          const val = select.value;
          for(const key in detected) if(detected[key]===k) detected[key]=null;
          if(val) detected[val]=k;
        });
        row.appendChild(label); row.appendChild(select); columnsDiv.appendChild(row);
      }
    }

    generateBtn?.addEventListener('click', async ()=>{
      if(!sheetData || sheetData.length===0){ alert('Carregue uma planilha primeiro.'); return; }
      const mode = modeSelect.value;
      const emailCol = detected.email;
      const inscrCol = detected.inscricao;
      const senhaCol = detected.senha;
      const combinedCol = detected.combined || null;
      if(!emailCol && !combinedCol){ alert('Não foi possível detectar a coluna de e‑mail. Ajuste o mapeamento.'); return; }
      if(mode==='inscricao' && !inscrCol && !combinedCol){ alert('Modo email+inscrição selecionado, mas não foi detectada coluna de inscrição.'); return; }
      if(mode==='senha' && !senhaCol){ alert('Modo email+senha selecionado, mas não foi detectada coluna de senha.'); return; }

      summary.textContent = 'Gerando hashes...';
      const hashes = [];
      for(let i=0;i<sheetData.length;i++){
        const row = sheetData[i];
        let email = '';
        let keyPart = '';
        if(combinedCol){
          const raw = String(row[combinedCol] || '').trim();
          if(!raw) continue;
          let parts = raw.split(/[,;|\t]+/).map(s=>s.trim()).filter(Boolean);
          if(parts.length < 2){ parts = raw.split(/\s+/).map(s=>s.trim()).filter(Boolean); }
          email = (parts[0] || '').toLowerCase();
          keyPart = (parts[1] || '').toString();
        } else {
          email = String(row[emailCol] || '').trim().toLowerCase();
          keyPart = mode==='inscricao' ? String(row[inscrCol] || '').trim() : String(row[senhaCol] || '').trim();
        }
        if(!email || !keyPart) continue;
        const h = await sha256Hex(email + keyPart);
        hashes.push(h);
        if(i%200===0) await new Promise(r=>setTimeout(r,0));
      }

      const combined = Array.from(new Set([...(mergedHashes||[]), ...hashes]));
      mergedHashes = combined;

      preview.textContent = combined.slice(0,20).map((h,i)=>`${i+1}. ${h}`).join('\n') || '—';
      summary.textContent = `Hashes gerados: ${hashes.length} (total após mesclagem: ${combined.length})`;
      downloadBtn.classList.remove('hidden');
    });

    downloadBtn?.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(mergedHashes, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'hashes_membros.json'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>

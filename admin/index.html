<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Gerar Hashes de Membros (Protegido)</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- CSP básica (reforçar via headers no Cloudflare). Ajuste o domínio do Worker em connect-src se usar workers.dev. -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self'; connect-src 'self' https://aprovacaopsycho.net; frame-ancestors 'none'; base-uri 'none'; form-action 'self'">
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- SheetJS local para leitura de planilhas -->
  <script src="/assets/xlsx.full.min.js" defer></script>
  <style>
    :root{--bg1:#07090d;--bg2:#0e141a;--card:#0f1822;--muted:#a5b4c3;--stroke:#1f2a36;--brand:#2563eb;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef6}
    .container{max-width:1080px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid var(--stroke);color:#e6eef6}
    input,select{background:transparent;border:1px solid var(--stroke);color:#e6eef6;border-radius:10px;padding:8px 10px}
    input[type=file]{padding:8px;background:transparent}
    h1,h2,h3,p{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    pre{white-space:pre-wrap;background:#0b1117;border:1px solid var(--stroke);border-radius:10px;padding:10px;min-height:140px}
    .hidden{display:none}
    .kbd{background:#0b1117;border:1px solid var(--stroke);padding:2px 6px;border-radius:6px;color:#9ec1ff}
    .alert{padding:10px;border-radius:10px}
    .ok{background:#0b1a12;border:1px solid #123c27}
    .bad{background:#1a0b0b;border:1px solid #3c1212}
  </style>
</head>
<body>
  <!-- === Gate de autenticação (admin) === -->
  <div id="gate" class="container" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
    <div class="card" style="width:min(480px,96vw)">
      <h1 style="font-size:20px">Área Restrita — Administração</h1>
      <p class="muted" style="margin-bottom:8px">Acesse com seu e-mail e senha de administrador.</p>
      <div class="row" style="flex-direction:column;align-items:stretch">
        <label>
          <span class="muted" style="font-size:12px">E-mail</span>
          <input id="email" type="email" placeholder="admin@seudominio.com" autocomplete="username" style="width:100%">
        </label>
        <label>
          <span class="muted" style="font-size:12px">Senha</span>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" style="width:100%">
        </label>
        <button id="loginBtn" class="btn" style="width:100%">Entrar</button>
        <p class="muted" style="font-size:12px">O validador confere <span class="kbd">SHA‑256(email+senha)</span> contra <code>/admin/_private/hashes_administradores.json</code>.</p>
        <p id="gateMsg" class="alert bad hidden"></p>
      </div>
    </div>
  </div>

  <!-- === Aplicação protegida === -->
  <div id="app" class="container hidden">
    <header class="row" style="justify-content:space-between">
      <div>
        <h2>Admin — Gerar Hashes de Membros</h2>
        <p class="muted">Importe planilha (.xlsx/.xls/.csv) com e‑mail e senha/inscrição → gere hashes <strong>SHA‑256(email+chave)</strong> → baixe o JSON ou envie PR automático para o GitHub.</p>
      </div>
      <button id="logoutBtn" class="ghost btn">Sair</button>
    </header>

    <div class="card" style="margin-top:14px">
      <div class="row" style="margin-bottom:12px">
        <label class="ghost btn" for="file-sheet">Importar planilha</label>
        <input id="file-sheet" type="file" accept=".xlsx,.xls,.csv" class="hidden" />

        <label class="ghost btn" for="file-json">Importar JSON (opcional)</label>
        <input id="file-json" type="file" accept="application/json" class="hidden" />

        <div class="row">
          <label class="muted" for="mode">Modo</label>
          <select id="mode">
            <option value="inscricao">email + inscrição (padrão)</option>
            <option value="senha">email + senha</option>
          </select>
        </div>

        <button id="generate" class="btn">Gerar hashes</button>
        <button id="download" class="btn hidden">Baixar JSON</button>
      </div>

      <div class="grid">
        <section>
          <h3>Resumo</h3>
          <p id="summary" class="muted">Nenhuma planilha carregada.</p>
          <p class="muted" style="margin-top:6px">Mapeamento de colunas detectadas (ajuste se necessário):</p>
          <div id="columns" style="margin-top:6px"></div>
        </section>
        <section>
          <h3>Preview (primeiros 20)</h3>
          <pre id="preview">—</pre>
        </section>
      </div>

      <hr style="border-color:var(--stroke);margin:16px 0">

      <h3>Enviar direto ao GitHub (PR via Cloudflare Worker)</h3>
      <div class="row" style="margin-top:6px">
        <input id="api-url" placeholder="https://aprovacaopsycho.net/admin/api/put-hashes" style="min-width:360px;flex:1">
        <input id="api-key" type="password" placeholder="Admin API Key (ADMIN_BEARER)" style="min-width:240px">
        <button id="pushRemote" class="btn">Enviar ao GitHub (PR)</button>
      </div>
      <p class="muted" style="margin-top:6px">Somente os <em>hashes</em> são enviados. O Worker valida o <span class="kbd">Bearer</span>, mescla/deduplica e cria um Pull Request com <code>hashes_membros.json</code>.</p>
      <p id="remoteMsg" class="alert hidden" style="margin-top:8px"></p>
    </div>
  </div>

  <script>
    // ===== Utilidades =====
    const qs = (s)=>document.querySelector(s);
    const showEl = (el)=>el.classList.remove('hidden');
    const hideEl = (el)=>el.classList.add('hidden');

    async function sha256Hex(message){
      const data = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ===== Gate simples de autenticação =====
    const ADMIN_HASH_LIST_URL = '/admin/_private/hashes_administradores.json';

    async function fetchAdminHashes(){
      try{
        const res = await fetch(ADMIN_HASH_LIST_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(Array.isArray(data)) return data;
        if(Array.isArray(data.validAdmins)) return data.validAdmins.map(v=>v.hash);
        if(Array.isArray(data.validHashes)) return data.validHashes;
        return [];
      }catch(e){
        console.error('Falha ao carregar lista de admins:', e);
        return [];
      }
    }

    async function doLogin(){
      const email = qs('#email').value.trim().toLowerCase();
      const pass  = qs('#password').value;
      const msgEl = qs('#gateMsg');
      msgEl.textContent = '';
      hideEl(msgEl);
      if(!email || !pass){ msgEl.textContent = 'Informe e-mail e senha.'; showEl(msgEl); return; }
      const candidate = await sha256Hex(email + pass);
      const list = await fetchAdminHashes();
      if(list.includes(candidate)){
        sessionStorage.setItem('admin_auth_hash', candidate);
        hideEl(qs('#gate')); showEl(qs('#app'));
      }else{
        msgEl.textContent = 'Credenciais inválidas.'; showEl(msgEl);
      }
    }

    function doLogout(){ sessionStorage.removeItem('admin_auth_hash'); location.reload(); }

    qs('#loginBtn').addEventListener('click', doLogin);
    qs('#logoutBtn').addEventListener('click', doLogout);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !qs('#app').classList.contains('hidden')) return; if(e.key==='Enter') doLogin(); });

    // ===== Gerador de hashes =====
    let sheetData = [];
    let detected = { email:null, inscricao:null, senha:null, combined:null };
    let mergedHashes = [];

    const fileSheet = qs('#file-sheet');
    const fileJSON  = qs('#file-json');
    const summary   = qs('#summary');
    const columnsDiv= qs('#columns');
    const preview   = qs('#preview');
    const generateBtn = qs('#generate');
    const downloadBtn = qs('#download');
    const modeSelect  = qs('#mode');

    // tornar botões label clicáveis
    document.querySelector("label[for='file-sheet']").addEventListener('click',()=>fileSheet.click());
    document.querySelector("label[for='file-json']").addEventListener('click',()=>fileJSON.click());

    fileSheet.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      summary.textContent = 'Carregando...'; sheetData = [];
      try{
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
        sheetData = json; summary.textContent = `Linhas lidas: ${json.length}`;
        detectColumns(json);
      }catch(e){ console.error(e); summary.textContent = 'Falha ao ler a planilha: '+e.message; }
    });

    fileJSON.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      try{
        const text = await f.text(); const data = JSON.parse(text);
        if(Array.isArray(data)) mergedHashes = data.slice();
        else if(Array.isArray(data.validHashes)) mergedHashes = data.validHashes.slice();
        else mergedHashes = [];
        summary.textContent = `JSON carregado: ${mergedHashes.length} hashes`;
      }catch(e){ console.error(e); summary.textContent = 'Falha ao ler JSON: '+e.message; }
    });

    function detectColumns(json){
      detected = { email:null, inscricao:null, senha:null, combined:null };
      if(!json || !json.length){ columnsDiv.innerHTML = '—'; return; }
      const keys = Object.keys(json[0]);
      for(const k of keys){ const l=k.toLowerCase();
        if(!detected.email && l.includes('email')) detected.email=k;
        if(!detected.inscricao && (l.includes('inscr')||l.includes('inscrição')||l.includes('matricula')||l.includes('matrícula')||l.includes('id'))) detected.inscricao=k;
        if(!detected.senha && l.includes('senha')) detected.senha=k;
      }
      columnsDiv.innerHTML='';
      for(const k of keys){
        const row = document.createElement('div'); row.className='row';
        const label=document.createElement('div'); label.textContent=k; label.style.flex='1';
        const select=document.createElement('select'); select.innerHTML=`<option value="">-- ignorar --</option><option value="email">email</option><option value="inscricao">inscricao</option><option value="senha">senha</option>`; select.value=(detected.email===k?'email':(detected.inscricao===k?'inscricao':(detected.senha===k?'senha':'')));
        select.addEventListener('change',()=>{ for(const key in detected) if(detected[key]===k) detected[key]=null; if(select.value) detected[select.value]=k; });
        row.appendChild(label); row.appendChild(select); columnsDiv.appendChild(row);
      }
    }

    generateBtn.addEventListener('click', async ()=>{
      if(!sheetData.length){ alert('Carregue uma planilha primeiro.'); return; }
      const mode = modeSelect.value; const emailCol=detected.email; const inscrCol=detected.inscricao; const senhaCol=detected.senha;
      if(!emailCol){ alert('Não foi possível detectar a coluna de e-mail.'); return; }
      if(mode==='inscricao' && !inscrCol){ alert('Selecione/ajuste a coluna de inscrição.'); return; }
      if(mode==='senha' && !senhaCol){ alert('Selecione/ajuste a coluna de senha.'); return; }

      summary.textContent = 'Gerando hashes...';
      const hashes=[];
      for(let i=0;i<sheetData.length;i++){
        const row=sheetData[i];
        const email=String(row[emailCol]||'').trim().toLowerCase();
        const keyPart=mode==='inscricao'? String(row[inscrCol]||'').trim() : String(row[senhaCol]||'').trim();
        if(!email || !keyPart) continue;
        const h = await sha256Hex(email+keyPart); hashes.push(h);
        if(i%250===0) await new Promise(r=>setTimeout(r,0));
      }
      const combined = Array.from(new Set([...(mergedHashes||[]), ...hashes]));
      mergedHashes = combined;
      preview.textContent = combined.slice(0,20).map((h,i)=>`${i+1}. ${h}`).join('\n') || '—';
      summary.textContent = `Hashes gerados: ${hashes.length} (total após mesclagem: ${combined.length})`;
      showEl(downloadBtn);
    });

    downloadBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(mergedHashes,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='hashes_membros.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ===== Envio seguro ao GitHub (Worker) =====
    async function pushHashesToServer(){
      const apiUrl = qs('#api-url').value.trim();
      const apiKey = qs('#api-key').value.trim();
      const msgEl = qs('#remoteMsg');
      msgEl.className='alert'; msgEl.textContent=''; hideEl(msgEl);
      if(!apiUrl || !apiKey){ msgEl.textContent='Preencha API URL e Admin API Key.'; msgEl.classList.add('bad'); showEl(msgEl); return; }
      if(!Array.isArray(mergedHashes) || !mergedHashes.length){ msgEl.textContent='Gere hashes primeiro.'; msgEl.classList.add('bad'); showEl(msgEl); return; }
      const onlyHex = mergedHashes.filter(h=>/^[a-f0-9]{64}$/.test(h));
      try{
        const res = await fetch(apiUrl, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+apiKey }, body: JSON.stringify({ hashes: onlyHex }) });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){ throw new Error((data && data.error) || ('HTTP '+res.status)); }
        msgEl.textContent = `OK ✅ PR #${data.pr_number || '?'} criado. Novos: ${data.added}. Total: ${data.total}.`; msgEl.classList.add('ok'); showEl(msgEl);
      }catch(e){ msgEl.textContent='Falha ao enviar: '+e.message; msgEl.classList.add('bad'); showEl(msgEl); }
    }
    qs('#pushRemote').addEventListener('click', pushHashesToServer);
  </script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Gerar Hashes de Membros (Protegido)</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- CSP via <meta> (nota: frame-ancestors é ignorado em meta; se quiser, aplique via header no Cloudflare) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src 'self' https://fonts.gstatic.com;
                 script-src 'self';
                 connect-src 'self' https://aprovacaopsycho.net;
                 base-uri 'none';
                 form-action 'self'">
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#07090d;--bg2:#0e141a;--card:#0f1822;--muted:#a5b4c3;--stroke:#1f2a36;--brand:#2563eb;--ok:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef6}
    .container{max-width:1080px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid var(--stroke);color:#e6eef6}
    input,select{background:transparent;border:1px solid var(--stroke);color:#e6eef6;border-radius:10px;padding:8px 10px}
    input[type=file]{padding:8px;background:transparent}
    h1,h2,h3,p{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    pre{white-space:pre-wrap;background:#0b1117;border:1px solid var(--stroke);border-radius:10px;padding:10px;min-height:140px}
    .hidden{display:none}
    .alert{padding:10px;border-radius:10px}
    .ok{background:#0b1a12;border:1px solid #123c27}
    .bad{background:#1a0b0b;border:1px solid #3c1212}
  </style>
</head>
<body>
  <!-- Gate -->
  <div id="gate" class="container" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
    <div class="card" style="width:min(480px,96vw)">
      <h1 style="font-size:20px">Área Restrita — Administração</h1>
      <p class="muted" style="margin-bottom:8px">Acesse com seu e-mail e senha de administrador.</p>
      <div class="row" style="flex-direction:column;align-items:stretch">
        <label>
          <span class="muted" style="font-size:12px">E-mail</span>
          <input id="email" type="email" placeholder="admin@seudominio.com" autocomplete="username" style="width:100%">
        </label>
        <label>
          <span class="muted" style="font-size:12px">Senha</span>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" style="width:100%">
        </label>
        <button id="loginBtn" class="btn" style="width:100%">Entrar</button>
        <p class="muted" style="font-size:12px">Validação: <code>SHA-256(email+senha)</code> em <code>/admin/private/hashes_administradores.json</code> (fallback: <code>/admin/_private/...</code>).</p>
        <p id="gateMsg" class="alert bad hidden"></p>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="container hidden">
    <header class="row" style="justify-content:space-between">
      <div>
        <h2>Admin — Gerar Hashes de Membros</h2>
        <p class="muted">Importe planilha (.xlsx/.xls/.csv) com e-mail e senha/inscrição → gere hashes <strong>SHA-256(email+chave)</strong> → baixe o JSON ou envie PR automático.</p>
      </div>
      <button id="logoutBtn" class="ghost btn">Sair</button>
    </header>

    <div class="card" style="margin-top:14px">
      <div class="row" style="margin-bottom:12px">
        <label class="ghost btn" for="file-sheet">Importar planilha</label>
        <input id="file-sheet" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
        <label class="ghost btn" for="file-json">Importar JSON (opcional)</label>
        <input id="file-json" type="file" accept="application/json" class="hidden" />
        <div class="row">
          <label class="muted" for="mode">Modo</label>
          <select id="mode">
            <option value="inscricao">email + inscrição (padrão)</option>
            <option value="senha">email + senha</option>
          </select>
        </div>
        <button id="generate" class="btn">Gerar hashes</button>
        <button id="download" class="btn hidden">Baixar JSON</button>
      </div>

      <div class="grid">
        <section>
          <h3>Resumo</h3>
          <p id="summary" class="muted">Nenhuma planilha carregada.</p>
          <p class="muted" style="margin-top:6px">Mapeamento de colunas detectadas (ajuste se necessário):</p>
          <div id="columns" style="margin-top:6px"></div>
        </section>
        <section>
          <h3>Preview (primeiros 20)</h3>
          <pre id="preview">—</pre>
        </section>
      </div>

      <hr style="border-color:var(--stroke);margin:16px 0">

      <h3>Enviar direto ao GitHub (PR via Cloudflare Worker)</h3>
      <div class="row" style="margin-top:6px">
        <input id="api-url" placeholder="https://aprovacaopsycho.net/admin/api/put-hashes" style="min-width:360px;flex:1">
        <input id="api-key" type="password" placeholder="Admin API Key (ADMIN_BEARER)" style="min-width:240px">
        <button id="pushRemote" class="btn">Enviar ao GitHub (PR)</button>
      </div>
      <p class="muted" style="margin-top:6px">Somente os <em>hashes</em> são enviados. O Worker valida o Bearer, mescla/deduplica e cria o PR com <code>hashes_membros.json</code>.</p>
      <p id="remoteMsg" class="alert hidden" style="margin-top:8px"></p>
    </div>
  </div>

  <!-- Scripts (ordem importa: SheetJS → app.js) -->
  <script src="/assets/xlsx.full.min.js" defer></script>
  <script src="/admin/app.js" defer></script>
</body>
</html>

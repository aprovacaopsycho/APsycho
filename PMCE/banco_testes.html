<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Testes Psicol√≥gicos - Seguran√ßa P√∫blica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#0f172a',
                        'brand-panel': '#1e293b',
                        'brand-blue': '#3b82f6',
                        'brand-accent': '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Toast Notification Animation */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast.show {
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-brand-dark text-slate-200 font-sans h-screen flex overflow-hidden">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Dados salvos com sucesso!</span>
    </div>

    <!-- Sidebar / Menu de Bancas -->
    <aside class="w-64 bg-brand-panel border-r border-slate-700 flex flex-col shadow-2xl z-30 flex-shrink-0">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fas fa-brain text-brand-blue"></i>
                PsicoData <span class="text-xs bg-brand-blue text-white px-2 py-0.5 rounded-full">2025</span>
            </h1>
            <p class="text-xs text-slate-400 mt-2">Banco de Dados Consolidado</p>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="banca-menu">
            <!-- Menu items ser√£o gerados via JS -->
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-800/50 space-y-3">
            <button onclick="selectManagerView()" id="btn-manager-view"
                class="w-full text-left px-4 py-3 rounded-lg transition-all flex items-center gap-3 text-slate-300 hover:bg-slate-700 hover:text-white border border-transparent hover:border-slate-600">
                <i class="fas fa-table-list text-brand-accent"></i>
                <div>
                    <span class="block text-sm font-bold">Cat√°logo & Edi√ß√£o</span>
                    <span class="block text-[10px] text-slate-500">Gerenciar nomes e tipos</span>
                </div>
            </button>

            <!-- √Årea de Backup -->
            <div class="pt-2 border-t border-slate-700/50">
                <p class="text-[10px] uppercase text-slate-500 font-bold mb-2 px-1">Backup & Seguran√ßa</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportData()"
                        class="bg-slate-700 hover:bg-slate-600 text-white text-xs py-2 rounded flex flex-col items-center gap-1 transition-colors"
                        title="Baixar arquivo de seguran√ßa">
                        <i class="fas fa-download text-brand-blue"></i>
                        Salvar
                    </button>
                    <label
                        class="bg-slate-700 hover:bg-slate-600 text-white text-xs py-2 rounded flex flex-col items-center gap-1 cursor-pointer transition-colors"
                        title="Carregar arquivo salvo">
                        <i class="fas fa-upload text-brand-accent"></i>
                        Ler
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                    </label>
                </div>
            </div>

            <button onclick="resetData()"
                class="w-full text-xs text-slate-500 hover:text-red-400 transition-colors flex items-center justify-center gap-2 pt-2">
                <i class="fas fa-trash-alt"></i> Resetar F√°brica
            </button>
        </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="flex-1 flex flex-col h-full relative min-w-0">

        <!-- Header Din√¢mico -->
        <header
            class="bg-brand-panel border-b border-slate-700 p-6 flex justify-between items-center shadow-lg z-20 flex-shrink-0">
            <div>
                <h2 id="current-page-title" class="text-3xl font-bold text-white">Carregando...</h2>
                <p id="current-page-subtitle" class="text-slate-400 text-sm mt-1">...</p>
            </div>
            <div class="flex gap-3" id="header-actions">
                <!-- Bot√µes injetados via JS -->
            </div>
        </header>

        <!-- VIEW: BANCAS (FILTROS + CARDS + STATS) -->
        <div id="view-banca" class="flex-1 overflow-hidden p-6 flex flex-col lg:flex-row gap-6 hidden">

            <!-- Coluna Esquerda: Filtros e Lista -->
            <div class="flex-1 flex flex-col min-h-0 gap-4">

                <!-- Barra de Filtros -->
                <div
                    class="bg-brand-panel border border-slate-700 p-4 rounded-xl flex flex-col sm:flex-row gap-4 items-center shadow-md flex-shrink-0">
                    <div class="flex items-center gap-2 text-slate-400 text-sm font-semibold uppercase tracking-wider">
                        <i class="fas fa-filter text-brand-accent"></i> Filtros
                    </div>
                    <div class="flex-1 grid grid-cols-2 gap-4 w-full">
                        <select id="filter-year" onchange="applyFilters()"
                            class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-brand-blue focus:border-brand-blue block w-full p-2.5">
                            <option value="all">Todos os Anos</option>
                        </select>
                        <select id="filter-concurso" onchange="applyFilters()"
                            class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-brand-blue focus:border-brand-blue block w-full p-2.5">
                            <option value="all">Todos os Concursos</option>
                        </select>
                    </div>
                    <button onclick="clearFilters()"
                        class="text-slate-400 hover:text-white text-sm underline px-2">Limpar</button>
                </div>

                <!-- Lista de Cards (Scrollable) -->
                <div id="cards-container" class="flex-1 overflow-y-auto space-y-4 pr-2">
                    <!-- Cards renderizados aqui -->
                </div>
            </div>

            <!-- Coluna Direita: Estat√≠sticas (Sticky) -->
            <div class="w-full lg:w-96 flex-shrink-0 flex flex-col gap-4">
                <div
                    class="bg-brand-panel border border-slate-700 rounded-xl p-5 shadow-lg flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-start border-b border-slate-700 pb-3 mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-chart-pie text-brand-accent"></i>
                            Estat√≠sticas
                        </h3>
                    </div>

                    <!-- Filtro de Tipo de Teste -->
                    <div class="mb-4">
                        <label class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1 block">Filtrar por
                            Tipo:</label>
                        <select id="filter-stats-type" onchange="applyStatsFilter()"
                            class="bg-slate-800 border border-slate-600 text-white text-xs rounded-lg focus:ring-brand-blue focus:border-brand-blue block w-full p-2">
                            <option value="all">Todos os Tipos</option>
                            <option value="Personalidade">üß† Personalidade</option>
                            <option value="Aten√ß√£o">üéØ Aten√ß√£o</option>
                            <option value="Racioc√≠nio">üí° Racioc√≠nio/Intelig√™ncia</option>
                            <option value="Mem√≥ria">üíæ Mem√≥ria</option>
                            <option value="Outros">‚ùì Outros</option>
                        </select>
                    </div>

                    <div class="flex-1 overflow-y-auto pr-1">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Mais Cobrados</p>
                            <span id="stats-count-badge"
                                class="text-[10px] bg-slate-700 px-2 py-0.5 rounded-full text-slate-300">0 testes</span>
                        </div>

                        <div id="stats-container" class="space-y-3">
                            <!-- Stats renderizados aqui -->
                        </div>
                    </div>

                    <div
                        class="mt-4 pt-4 border-t border-slate-700 text-[10px] text-slate-500 text-center flex justify-center gap-3">
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-purple-500"></span>Pers.</span>
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-yellow-500"></span>Aten.</span>
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-green-500"></span>Mem.</span>
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-blue-500"></span>Rac.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: MANAGER (TABELA DE EDI√á√ÉO) -->
        <div id="view-manager" class="flex-1 overflow-hidden p-6 flex flex-col hidden">
            <!-- Barra de Busca -->
            <div
                class="bg-brand-panel border border-slate-700 p-4 rounded-xl mb-4 flex gap-4 items-center shadow-md flex-shrink-0">
                <i class="fas fa-search text-slate-400 text-lg"></i>
                <input type="text" id="manager-search" onkeyup="renderManagerTable()"
                    placeholder="Buscar teste por nome..."
                    class="bg-transparent border-none text-white w-full focus:ring-0 text-lg outline-none">
            </div>

            <!-- Tabela Container -->
            <div
                class="bg-brand-panel border border-slate-700 rounded-xl shadow-lg flex-1 overflow-hidden flex flex-col">
                <div class="overflow-y-auto flex-1">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs uppercase bg-slate-900 text-slate-400 sticky top-0 z-10 shadow-md">
                            <tr>
                                <th scope="col" class="px-6 py-4 w-1/3">Nome Original (Dados Brutos)</th>
                                <th scope="col" class="px-6 py-4 w-1/3">Nome Padr√£o / Sin√¥nimo <i
                                        class="fas fa-info-circle ml-1 text-slate-500"
                                        title="Agrupa testes diferentes sob o mesmo nome nas estat√≠sticas"></i></th>
                                <th scope="col" class="px-6 py-4 w-1/3">Classifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="manager-table-body" class="divide-y divide-slate-700">
                            <!-- Linhas geradas via JS -->
                        </tbody>
                    </table>
                </div>
                <div
                    class="p-3 bg-slate-800/50 border-t border-slate-700 text-xs text-slate-500 text-center flex justify-between items-center">
                    <span><i class="fas fa-save text-green-400 mr-1"></i> Altera√ß√µes salvas automaticamente no
                        navegador.</span>
                    <button onclick="exportData()" class="text-brand-blue hover:text-white underline">Fazer backup
                        externo</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal de Edi√ß√£o de Concurso -->
    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div
            class="bg-brand-panel border border-slate-600 rounded-xl w-full max-w-lg shadow-2xl transform transition-all scale-100">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-white">Adicionar Concurso</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <input type="hidden" id="modal-index">

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-slate-400 mb-1">Ano</label>
                        <input type="number" id="modal-ano"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-brand-blue outline-none transition-all">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-slate-400 mb-1">Nome do Concurso/√ìrg√£o</label>
                        <input type="text" id="modal-concurso"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white focus:ring-2 focus:ring-brand-blue outline-none transition-all"
                            placeholder="Ex: PM-PE (Soldado)">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Testes Aplicados</label>
                    <p class="text-xs text-slate-500 mb-2">Separe os testes por v√≠rgula ou nova linha.</p>
                    <textarea id="modal-testes" rows="6"
                        class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-brand-blue outline-none transition-all font-mono text-sm"
                        placeholder="Ex: Palogr√°fico&#10;NEO PI-R&#10;Teste de Mem√≥ria"></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-slate-700 bg-slate-800/30 flex justify-end gap-3 rounded-b-xl">
                <button onclick="closeModal()"
                    class="px-4 py-2 text-slate-300 hover:text-white font-medium transition-colors">Cancelar</button>
                <button onclick="saveData()"
                    class="bg-brand-blue hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all shadow-lg">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Script de L√≥gica -->
    <script>
        // --- UTILIT√ÅRIOS ---
        function normalizeString(str) {
            return str ? str.trim().toUpperCase() : "";
        }

        // Fun√ß√£o Toast
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast-container');
            const msgEl = document.getElementById('toast-message');
            msgEl.textContent = msg;
            toast.classList.add('show');

            // Auto hide
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- DADOS PADR√ÉO ---
        const defaultTestTypes = {
            "NEO PI": "Personalidade", "NEO PI-R": "Personalidade", "NEO FII R": "Personalidade", "NEO-PI": "Personalidade", "NEO PPI": "Personalidade",
            "IFP": "Personalidade", "IFP II": "Personalidade", "IFP 2": "Personalidade", "IFP-II": "Personalidade", "IFP-R": "Personalidade",
            "BFP": "Personalidade", "BPR-5 RV": "Personalidade", "BPF": "Personalidade",
            "PALOGR√ÅFICO": "Personalidade", "PALO": "Personalidade", "PALOGRAFICO": "Personalidade",
            "PMK": "Personalidade", "CPS": "Personalidade", "QUATI": "Personalidade", "IHS": "Personalidade", "EFN-R": "Personalidade", "MIG": "Personalidade",
            "TEACO": "Aten√ß√£o", "TEACO-FF": "Aten√ß√£o",
            "TEADI": "Aten√ß√£o", "TEADI 2": "Aten√ß√£o",
            "TEALT": "Aten√ß√£o",
            "CTA": "Aten√ß√£o", "CTA-AD": "Aten√ß√£o", "CTA-AC": "Aten√ß√£o", "CTA COMPLETO": "Aten√ß√£o", "CTA CONCENTRADO": "Aten√ß√£o", "CTA DIVIDIDO": "Aten√ß√£o", "CTA ALTERNADO": "Aten√ß√£o",
            "BPA": "Aten√ß√£o", "BPA AC/AD/AA": "Aten√ß√£o", "BPA(AC E AD)": "Aten√ß√£o",
            "AC VETOR": "Aten√ß√£o",
            "TEPIC": "Aten√ß√£o", "TEDIF 2": "Aten√ß√£o", "TADIS": "Aten√ß√£o", "EATA": "Aten√ß√£o",
            "MEM√ìRIA": "Mem√≥ria", "MEM√ìRIA F": "Mem√≥ria", "MEM√ìRIA DE FACES": "Mem√≥ria", "MEM√ìRIA F FACES": "Mem√≥ria", "MVR": "Mem√≥ria", "MVR FACES DUPLAS": "Mem√≥ria",
            "TSP MEM√ìRIA": "Mem√≥ria", "TSP (MEMO)": "Mem√≥ria", "TSP": "Mem√≥ria",
            "TEM-R": "Mem√≥ria", "TEM R": "Mem√≥ria", "TIME-R": "Mem√≥ria", "TMR": "Mem√≥ria",
            "R1": "Racioc√≠nio", "G36": "Racioc√≠nio", "G 36": "Racioc√≠nio", "G38": "Racioc√≠nio",
            "BETA 3": "Racioc√≠nio", "BETA III": "Racioc√≠nio", "BETA 3 MATRICIAL": "Racioc√≠nio", "BETA III MATRICIAL": "Racioc√≠nio", "BETA III C√ìDIGOS": "Racioc√≠nio",
            "BRD": "Racioc√≠nio", "BRD RV": "Racioc√≠nio", "BRD-RV": "Racioc√≠nio", "BRD-AR": "Racioc√≠nio",
            "TIG": "Racioc√≠nio", "TIG NV": "Racioc√≠nio",
            "WMT-2": "Racioc√≠nio", "WMT 2": "Racioc√≠nio",
            "CUBOS": "Racioc√≠nio", "TRL": "Racioc√≠nio", "TRI": "Racioc√≠nio",
            "RAVEN": "Racioc√≠nio", "HTM": "Racioc√≠nio",
            "ESAVI": "Racioc√≠nio", "ESAVI A": "Racioc√≠nio", "ESAVI B": "Racioc√≠nio", "ESAVI-B": "Racioc√≠nio"
        };

        const defaultAliases = {
            "NEO-PI": "NEO PI-R", "NEO PI": "NEO PI-R", "NEO PIR": "NEO PI-R", "NEO-PIR": "NEO PI-R", "NEO FII R": "NEO PI-R",
            "IFP 2": "IFP-II", "IFP2": "IFP-II", "IFP II": "IFP-II",
            "PALO": "PALOGR√ÅFICO", "PALOGRAFICO": "PALOGR√ÅFICO",
            "BETA 3": "BETA-III", "BETA III": "BETA-III", "BETA-3": "BETA-III",
            "WMT 2": "WMT-2", "WMT2": "WMT-2",
            "AC VETOR": "AC-VETOR"
        };

        const defaultData = {
            "AOCP": [
                { ano: 2025, concurso: "PMPR - CFO", testes: ["NEO PI", "IFP II", "TRI", "R1", "TSP Dimens√µes", "TEADI", "AC Vetor", "TEPIC"] },
                { ano: 2024, concurso: "PM-PE (Soldado)", testes: ["TEPIC", "NEO PI", "TEACO", "TRI", "PALOGR√ÅFICO"] },
                { ano: 2024, concurso: "PM-PE (Oficial)", testes: ["AC VETOR", "NEO PI", "R1", "PALOGR√ÅFICO", "TEPIC"] },
                { ano: 2024, concurso: "PM-DF (Reteste)", testes: ["TEACO", "NEO PI", "R1", "TEPIC"] },
                { ano: 2024, concurso: "PM-DF", testes: ["NEO-PI", "TEACO", "TSP", "BFP", "WMT-2"] },
                { ano: 2023, concurso: "PM-ES", testes: ["V-47", "BPR-5 RV", "AC VETOR", "BPF", "TEPIC"] },
                { ano: 2023, concurso: "MP-RR", testes: ["BPA", "NEO PI", "IFP 2", "R1", "V-47"] },
                { ano: 2023, concurso: "PC-GO", testes: ["BPA", "CTA", "BFP", "IFP 2"] }
            ],
            "IBFC": [
                { ano: 2025, concurso: "PP-GO", testes: ["Palogr√°fico", "CTA completo", "MVR faces duplas", "BETA 3 MATRICIAL", "BFP"] },
                { ano: 2024, concurso: "PP-AC", testes: ["BFP", "MVR", "BPA AC/AD/AA", "BETA III MATRICIAL"] },
                { ano: 2024, concurso: "GCM MANAUS", testes: ["NEO PI", "MVR", "BPA AC/AD/AA", "BETA III MATRICIAL", "PALOGR√ÅFICO"] },
                { ano: 2023, concurso: "PM-PB", testes: ["BFP", "EATA", "NEO PI", "BETA III MATRICIAL", "PALOGR√ÅFICO", "MVR", "TEACO"] },
                { ano: 2023, concurso: "PM-RN", testes: ["BFP", "MVR", "TEACO", "PALOGR√ÅFICO", "BETA III MATRICIAL"] },
                { ano: 2022, concurso: "PM-RN (Oficial)", testes: ["NEO PI R", "EATA", "BETA III MATRICIAL", "BFP"] },
                { ano: 2022, concurso: "CBM-AC", testes: ["BFP", "TMR", "TEACO", "PALOGR√ÅFICO"] }
            ],
            "CEBRASPE": [
                { ano: 2025, concurso: "PCCE (Delegado)", testes: ["BRD RV", "BFP", "IFP 2", "FACES", "TEADI"] },
                { ano: 2023, concurso: "PC-PE", testes: ["TEACO", "TEADI", "WMT-2", "IFP2", "BFP", "MEM√ìRIA F", "ESAVI B"] },
                { ano: 2023, concurso: "BM-AL (Oficial)", testes: ["TEACO", "CTA-AD", "CTA-AC", "TIG NV", "IFP-II", "ESAVI-B", "TARDE"] },
                { ano: 2021, concurso: "CBM-TO", testes: ["Palografico", "TEACO", "TEADI", "WMT 2", "BFP"] },
                { ano: 2021, concurso: "PM-TO", testes: ["TEACO-FF", "WMT-2", "TSP(MEMO)", "BFP", "CUBOS", "BRD-RV", "IFP-II"] }
            ],
            "IDECAN": [
                { ano: 2024, concurso: "GCM MARACANA√ö", testes: ["BFP", "Esavi", "Teaco", "Tealt"] },
                { ano: 2024, concurso: "GCM SERRA", testes: ["BFP", "ESAVI", "TEACO", "BETA 3 MATRICIAL"] },
                { ano: 2023, concurso: "PM-MS", testes: ["Beta III c√≥digos", "Tedif 2", "Mem√≥ria de faces"] }
            ],
            "FGV": [
                { ano: 2024, concurso: "PM-ERJ", testes: ["CTA CONCENTRADO", "CTA DIVIDIDO", "CTA ALTERNADO", "PALOGR√ÅFICO", "MEM√ìRIA DE FACES", "ESAVI A", "TIV", "NEO FII R"] },
                { ano: 2024, concurso: "PM-ESP", testes: ["BFP", "AC VETOR", "G38", "PALOGR√ÅFICO", "PMK", "TECON", "ENTREVISTA"] },
                { ano: 2022, concurso: "PC-RN", testes: ["AC VETOR", "TEADI", "BETA III", "BFP"] },
                { ano: 2022, concurso: "PM-PB", testes: ["AC VETOR", "BETA III", "BFP"] }
            ],
            "NUCEPE": [
                { ano: 2024, concurso: "PM-PI", testes: ["CTA", "MVR", "IPHEXA"] },
                { ano: 2024, concurso: "PCCE (Escriv√£o)", testes: ["BETA III", "BFP"] }
            ],
            "UECE": [
                { ano: 2025, concurso: "GCM SOBRAL", testes: ["PALOGR√ÅFICO", "ROTA C", "MIG"] },
                { ano: 2025, concurso: "SEAS", testes: ["PALOGR√ÅFICO", "G 36", "ROTA C", "MIG", "BFP", "AC VETOR"] },
                { ano: 2025, concurso: "PM-CE", testes: ["PALO", "G36", "ROTA C", "BFP", "Mem√≥ria F Faces"] },
                { ano: 2025, concurso: "PC-CE", testes: ["MIG", "ROTA D", "Palogr√°fico", "Mem√≥ria Faces", "BFP"] },
                { ano: 2025, concurso: "CBM-CE", testes: ["Mig", "Palo", "Rota A", "BDA", "Memoria TSP"] }
            ],
            "IGEDUC": [
                { ano: 2024, concurso: "GCM MORENO", testes: ["BFP", "MEM√ìRIA F", "EFN-R", "TRL"] }
            ],
            "CRS (PMMG)": [
                { ano: 2025, concurso: "PM-MG", testes: ["IFP II", "TEM R", "BETA III MATRICIAL", "ROTA C", "ROTA D", "PMK"] }
            ]
        };

        const typeColors = {
            "Personalidade": "bg-purple-500",
            "Aten√ß√£o": "bg-yellow-500",
            "Mem√≥ria": "bg-green-500",
            "Racioc√≠nio": "bg-blue-500",
            "Outros": "bg-gray-500"
        };

        // --- ESTADO GLOBAL ---
        let appData = {};
        let currentTestTypes = {};
        let currentAliases = {};

        // Estado de Visualiza√ß√£o
        let currentBanca = "";
        let currentView = "banca"; // 'banca' or 'manager'

        // Filtros da Banca
        let filterYearValue = "all";
        let filterConcursoValue = "all";
        let statsFilterValue = "all";
        let editingIndex = -1;

        // --- PERSIST√äNCIA & CARREGAMENTO ---
        function loadConfig() {
            // Tipos
            const normalizedDefaultTypes = {};
            for (const [key, val] of Object.entries(defaultTestTypes)) {
                normalizedDefaultTypes[normalizeString(key)] = val;
            }
            const savedTypes = localStorage.getItem('psicoDataTestTypes');
            currentTestTypes = { ...normalizedDefaultTypes, ...(savedTypes ? JSON.parse(savedTypes) : {}) };

            // Aliases
            const normalizedDefaultAliases = {};
            for (const [key, val] of Object.entries(defaultAliases)) {
                normalizedDefaultAliases[normalizeString(key)] = normalizeString(val);
            }
            const savedAliases = localStorage.getItem('psicoDataAliases');
            currentAliases = { ...normalizedDefaultAliases, ...(savedAliases ? JSON.parse(savedAliases) : {}) };
        }

        function loadData() {
            const saved = localStorage.getItem('psicoDataDB');
            if (saved) {
                appData = JSON.parse(saved);
            } else {
                appData = JSON.parse(JSON.stringify(defaultData));
            }
        }

        function saveDataToStorage() {
            localStorage.setItem('psicoDataDB', JSON.stringify(appData));
            showToast("Dados salvos com sucesso!");
        }

        // --- FUNCIONALIDADES DE EXPORTA√á√ÉO/IMPORTA√á√ÉO ---
        function exportData() {
            const data = {
                appData: appData,
                customTestTypes: JSON.parse(localStorage.getItem('psicoDataTestTypes') || '{}'),
                customAliases: JSON.parse(localStorage.getItem('psicoDataAliases') || '{}'),
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `psicodata_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("Arquivo de backup baixado!", "success");
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.appData) localStorage.setItem('psicoDataDB', JSON.stringify(data.appData));
                    if (data.customTestTypes) localStorage.setItem('psicoDataTestTypes', JSON.stringify(data.customTestTypes));
                    if (data.customAliases) localStorage.setItem('psicoDataAliases', JSON.stringify(data.customAliases));

                    alert("Dados restaurados com sucesso! A p√°gina ser√° recarregada.");
                    window.location.reload();
                } catch (err) {
                    alert("Erro ao ler arquivo de backup. Verifique se √© um JSON v√°lido.");
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        function resetData() {
            if (confirm("ATEN√á√ÉO: Isso apagar√° todas as suas edi√ß√µes e configura√ß√µes personalizadas. Deseja continuar?")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        // --- L√ìGICA DE DADOS DOS TESTES (CORE) ---
        function resolveTestName(rawName) {
            const normalized = normalizeString(rawName);
            return currentAliases[normalized] || normalized;
        }

        function getTestType(testName) {
            const normalized = normalizeString(testName);
            // 1. Match Exato
            if (currentTestTypes[normalized]) return currentTestTypes[normalized];
            // 2. Match Parcial (Fallback)
            for (const [key, value] of Object.entries(currentTestTypes)) {
                if (normalized.includes(key) && key.length > 3) return value;
            }
            return "Outros";
        }

        // --- L√ìGICA DE GERENCIAMENTO (MANAGER) ---
        function saveAlias(rawName, newAlias) {
            const key = normalizeString(rawName);
            const val = normalizeString(newAlias);

            if (val === "" || val === key) {
                delete currentAliases[key];
            } else {
                currentAliases[key] = val;
            }

            // Salvar Customiza√ß√µes
            const savedAliases = localStorage.getItem('psicoDataAliases');
            const customAliases = savedAliases ? JSON.parse(savedAliases) : {};
            if (val === "" || val === key) delete customAliases[key]; else customAliases[key] = val;
            localStorage.setItem('psicoDataAliases', JSON.stringify(customAliases));

            showToast("Sin√¥nimo atualizado!");

            // Atualiza UI se estiver na tela de manager
            if (currentView === 'manager') renderManagerTable();
        }

        function saveType(resolvedName, newType) {
            const key = normalizeString(resolvedName);
            currentTestTypes[key] = newType;

            // Salvar Customiza√ß√µes
            const savedTypes = localStorage.getItem('psicoDataTestTypes');
            const customTypes = savedTypes ? JSON.parse(savedTypes) : {};
            customTypes[key] = newType;
            localStorage.setItem('psicoDataTestTypes', JSON.stringify(customTypes));

            showToast("Classifica√ß√£o salva!");
        }


        // --- UI: NAVEGA√á√ÉO & MENUS ---
        function renderMenu() {
            const menu = document.getElementById('banca-menu');
            menu.innerHTML = '';

            const bancas = Object.keys(appData).sort();
            if (!currentBanca && bancas.length > 0) currentBanca = bancas[0];

            bancas.forEach(banca => {
                const btn = document.createElement('button');
                const isActive = (currentView === 'banca' && banca === currentBanca);

                btn.className = `w-full text-left px-4 py-3 rounded-lg mb-2 transition-all flex justify-between items-center group ${isActive
                    ? 'bg-brand-blue text-white shadow-lg shadow-blue-500/20'
                    : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                    }`;

                btn.onclick = () => selectBanca(banca);

                const count = appData[banca].length;
                btn.innerHTML = `
                    <span class="font-medium tracking-wide">${banca}</span>
                    <span class="text-xs ${isActive ? 'bg-blue-800 text-blue-200' : 'bg-slate-800 text-slate-500 group-hover:bg-slate-700'} px-2 py-0.5 rounded-full min-w-[24px] text-center">${count}</span>
                `;
                menu.appendChild(btn);
            });

            // Atualiza estilo do bot√£o Manager
            const btnManager = document.getElementById('btn-manager-view');
            if (currentView === 'manager') {
                btnManager.className = "w-full text-left px-4 py-3 rounded-lg transition-all flex items-center gap-3 bg-brand-accent/10 text-brand-accent border border-brand-accent/50";
            } else {
                btnManager.className = "w-full text-left px-4 py-3 rounded-lg transition-all flex items-center gap-3 text-slate-300 hover:bg-slate-700 hover:text-white border border-transparent hover:border-slate-600";
            }
        }

        function selectBanca(banca) {
            currentView = "banca";
            currentBanca = banca;

            document.getElementById('view-banca').classList.remove('hidden');
            document.getElementById('view-manager').classList.add('hidden');

            // Reset filters
            filterYearValue = "all"; filterConcursoValue = "all"; statsFilterValue = "all";
            document.getElementById('filter-year').value = "all";
            document.getElementById('filter-concurso').value = "all";
            document.getElementById('filter-stats-type').value = "all";

            renderMenu();
            renderContent();
        }

        function selectManagerView() {
            currentView = "manager";
            document.getElementById('view-banca').classList.add('hidden');
            document.getElementById('view-manager').classList.remove('hidden');

            renderMenu();
            renderManagerContent();
        }

        // --- UI: BANCA VIEW ---
        function renderContent(updateFilters = true) {
            const container = document.getElementById('cards-container');
            const titleEl = document.getElementById('current-page-title');
            const subtitleEl = document.getElementById('current-page-subtitle');
            const headerActions = document.getElementById('header-actions');

            // Setup Header for Banca View
            titleEl.textContent = currentBanca;

            headerActions.innerHTML = `
                 <button onclick="openModal('add')" class="bg-brand-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all shadow-lg hover:shadow-blue-500/20 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Novo Concurso
                </button>
            `;

            if (updateFilters) updateFilterOptions();

            const filteredData = getFilteredData();
            subtitleEl.textContent = `${filteredData.length} concurso(s) exibido(s)`;

            renderStats(filteredData); // Renderiza estat√≠sticas lateral

            container.innerHTML = '';

            if (filteredData.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-500 bg-brand-panel/30 rounded-xl border border-slate-700 border-dashed"><p>Nenhum concurso encontrado.</p></div>`;
                return;
            }

            const displayData = filteredData.sort((a, b) => b.ano - a.ano);

            displayData.forEach((item) => {
                const realIndex = appData[currentBanca].indexOf(item);
                const card = document.createElement('div');
                card.className = "bg-brand-panel border border-slate-700 rounded-xl p-5 shadow-lg hover:border-slate-500 transition-all group relative animate-fade-in";

                const badges = item.testes.map(teste => {
                    const resolvedName = resolveTestName(teste);
                    const type = getTestType(resolvedName);
                    const colorClass = typeColors[type] || "bg-gray-500";
                    let borderColor = "border-slate-700";
                    let textColor = "text-blue-300";

                    if (type === "Personalidade") { borderColor = "border-purple-500/30"; textColor = "text-purple-300"; }
                    if (type === "Aten√ß√£o") { borderColor = "border-yellow-500/30"; textColor = "text-yellow-300"; }
                    if (type === "Mem√≥ria") { borderColor = "border-green-500/30"; textColor = "text-green-300"; }
                    if (type === "Racioc√≠nio") { borderColor = "border-blue-500/30"; textColor = "text-blue-300"; }

                    const tooltip = resolvedName !== normalizeString(teste) ? `Alias de: ${resolvedName}` : type;

                    return `<span class="inline-block bg-slate-800 ${textColor} text-xs px-2 py-1 rounded border ${borderColor} mr-2 mb-2 hover:bg-slate-700 transition-colors cursor-default" title="${tooltip}">${teste}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="bg-brand-accent/10 text-brand-accent text-xs font-bold px-2 py-1 rounded border border-brand-accent/20 mb-2 inline-block">${item.ano}</span>
                            <h3 class="text-lg font-bold text-white leading-tight">${item.concurso}</h3>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute top-4 right-4 bg-brand-panel pl-2 shadow-[-10px_0_10px_#1e293b]">
                            <button onclick="openModal('edit', ${realIndex})" class="text-slate-400 hover:text-brand-blue p-1.5 hover:bg-slate-800 rounded transition-colors" title="Editar"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteItem(${realIndex})" class="text-slate-400 hover:text-red-400 p-1.5 hover:bg-slate-800 rounded transition-colors" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="mt-2"><div class="flex flex-wrap">${badges}</div></div>
                `;
                container.appendChild(card);
            });
        }

        // --- UI: MANAGER VIEW ---
        function renderManagerContent() {
            document.getElementById('current-page-title').textContent = "Cat√°logo de Testes";
            document.getElementById('current-page-subtitle').textContent = "Gerencie nomes padronizados e classifica√ß√µes.";
            document.getElementById('header-actions').innerHTML = ''; // Sem bot√µes extras

            renderManagerTable();
        }

        function renderManagerTable() {
            const tbody = document.getElementById('manager-table-body');
            const searchVal = document.getElementById('manager-search').value.toLowerCase();
            tbody.innerHTML = '';

            // 1. Coletar todos os testes √∫nicos
            const allTests = new Set();
            for (const banca in appData) {
                appData[banca].forEach(item => {
                    item.testes.forEach(t => allTests.add(t));
                });
            }

            // Ordenar alfabeticamente
            const sortedTests = Array.from(allTests).sort();

            sortedTests.forEach(rawTestName => {
                // Filtro de busca
                if (searchVal && !rawTestName.toLowerCase().includes(searchVal)) return;

                const normalized = normalizeString(rawTestName);
                const resolved = resolveTestName(rawTestName);
                const isAlias = resolved !== normalized;
                const currentType = getTestType(resolved);

                const tr = document.createElement('tr');
                tr.className = "bg-slate-800 border-b border-slate-700 hover:bg-slate-700/50 transition-colors";

                // Visual Indicator for customized rows
                const isCustomized = isAlias || (currentTestTypes[normalized] && currentTestTypes[normalized] !== "Outros");
                if (isCustomized) tr.classList.add("bg-slate-700/20");

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white font-mono text-xs">${rawTestName}</td>
                    <td class="px-6 py-4">
                        <div class="relative">
                            <input type="text" 
                                value="${isAlias ? resolved : ''}" 
                                placeholder="${normalized}"
                                onchange="saveAlias('${rawTestName}', this.value)"
                                class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-brand-accent placeholder-slate-600 focus:ring-1 focus:ring-brand-blue outline-none"
                            >
                            ${isAlias ? '<i class="fas fa-link absolute right-3 top-3 text-brand-accent text-xs" title="Redirecionamento ativo"></i>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                         <select onchange="saveType('${resolved}', this.value)" class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded p-2 focus:ring-brand-blue focus:border-brand-blue outline-none">
                            <option value="Personalidade" ${currentType === 'Personalidade' ? 'selected' : ''}>Personalidade</option>
                            <option value="Aten√ß√£o" ${currentType === 'Aten√ß√£o' ? 'selected' : ''}>Aten√ß√£o</option>
                            <option value="Mem√≥ria" ${currentType === 'Mem√≥ria' ? 'selected' : ''}>Mem√≥ria</option>
                            <option value="Racioc√≠nio" ${currentType === 'Racioc√≠nio' ? 'selected' : ''}>Racioc√≠nio</option>
                            <option value="Outros" ${currentType === 'Outros' ? 'selected' : ''}>Outros</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }


        // --- HELPERS (FILTROS E MODAIS ANTIGOS) ---
        function updateFilterOptions() {
            const data = appData[currentBanca] || [];
            const yearSelect = document.getElementById('filter-year');
            const concursoSelect = document.getElementById('filter-concurso');

            const uniqueYears = [...new Set(data.map(item => item.ano))].sort((a, b) => b - a);
            const uniqueConcursos = [...new Set(data.map(item => item.concurso))].sort();

            yearSelect.innerHTML = '<option value="all">Todos os Anos</option>';
            uniqueYears.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
            yearSelect.value = uniqueYears.includes(parseInt(filterYearValue)) ? filterYearValue : "all";

            concursoSelect.innerHTML = '<option value="all">Todos os Concursos</option>';
            uniqueConcursos.forEach(c => concursoSelect.innerHTML += `<option value="${c}">${c}</option>`);
            concursoSelect.value = uniqueConcursos.includes(filterConcursoValue) ? filterConcursoValue : "all";
        }

        function applyFilters() {
            filterYearValue = document.getElementById('filter-year').value;
            filterConcursoValue = document.getElementById('filter-concurso').value;
            renderContent(false);
        }

        function clearFilters() {
            filterYearValue = "all"; filterConcursoValue = "all";
            renderContent();
        }

        function applyStatsFilter() {
            statsFilterValue = document.getElementById('filter-stats-type').value;
            renderContent(false);
        }

        function getFilteredData() {
            if (!currentBanca || !appData[currentBanca]) return [];
            return appData[currentBanca].filter(item => {
                const yearMatch = filterYearValue === "all" || item.ano.toString() === filterYearValue;
                const concursoMatch = filterConcursoValue === "all" || item.concurso === filterConcursoValue;
                return yearMatch && concursoMatch;
            });
        }

        function renderStats(filteredData) {
            const container = document.getElementById('stats-container');
            const badge = document.getElementById('stats-count-badge');
            container.innerHTML = '';
            const testCounts = {};

            filteredData.forEach(item => {
                item.testes.forEach(teste => {
                    const resolvedName = resolveTestName(teste);
                    testCounts[resolvedName] = (testCounts[resolvedName] || 0) + 1;
                });
            });

            let sortedTests = Object.entries(testCounts).sort((a, b) => b[1] - a[1]);
            if (statsFilterValue !== "all") {
                sortedTests = sortedTests.filter(([teste]) => getTestType(teste) === statsFilterValue);
            }

            badge.textContent = `${sortedTests.length} testes listados`;
            if (sortedTests.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-sm italic text-center mt-4">Nenhum teste encontrado.</p>';
                return;
            }

            const maxCount = sortedTests[0][1];
            sortedTests.forEach(([teste, count]) => {
                const percent = (count / maxCount) * 100;
                const type = getTestType(teste);
                const colorClass = typeColors[type] || "bg-gray-500";

                const item = document.createElement('div');
                item.className = "mb-2 group hover:bg-slate-800/50 p-1.5 rounded transition-colors";
                item.innerHTML = `
                    <div class="flex justify-between items-center text-xs mb-1">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="w-1.5 h-1.5 rounded-full flex-shrink-0 ${colorClass}" title="${type}"></span>
                            <span class="text-slate-200 font-medium truncate" title="${teste} (${type})">${teste}</span>
                        </div>
                        <span class="text-brand-accent font-bold ml-2">${count}x</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-1.5">
                        <div class="${colorClass} h-1.5 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- MODAL L√ìGICA ---
        const modal = document.getElementById('modal');
        function openModal(mode, index = -1) {
            editingIndex = index;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            const inpAno = document.getElementById('modal-ano');
            const inpConcurso = document.getElementById('modal-concurso');
            const inpTestes = document.getElementById('modal-testes');
            const modalTitle = document.getElementById('modal-title');

            if (mode === 'edit' && index > -1) {
                const item = appData[currentBanca][index];
                modalTitle.textContent = "Editar Concurso";
                inpAno.value = item.ano;
                inpConcurso.value = item.concurso;
                inpTestes.value = item.testes.join('\n');
            } else {
                modalTitle.textContent = "Adicionar Novo Concurso";
                inpAno.value = new Date().getFullYear();
                inpConcurso.value = "";
                inpTestes.value = "";
            }
        }
        function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

        function saveData() {
            const ano = parseInt(document.getElementById('modal-ano').value);
            const concurso = document.getElementById('modal-concurso').value.trim();
            const testes = document.getElementById('modal-testes').value.split(/[\n,]/).map(t => t.trim()).filter(t => t.length > 0);

            if (!ano || !concurso || testes.length === 0) { alert("Preencha todos os campos."); return; }
            const newItem = { ano, concurso, testes };

            if (editingIndex > -1) appData[currentBanca][editingIndex] = newItem;
            else { if (!appData[currentBanca]) appData[currentBanca] = []; appData[currentBanca].push(newItem); }

            appData[currentBanca].sort((a, b) => b.ano - a.ano);
            saveDataToStorage(); closeModal(); renderContent();
        }

        function deleteItem(index) {
            if (confirm("Excluir este registro?")) {
                appData[currentBanca].splice(index, 1);
                saveDataToStorage(); renderContent(false);
            }
        }

        // --- INICIALIZA√á√ÉO ---
        window.addEventListener('load', () => {
            loadConfig();
            loadData();
            for (let b in appData) appData[b].sort((a, b) => b.ano - a.ano);
            renderMenu();
            selectBanca(currentBanca || Object.keys(appData)[0]);
        });

    </script>
</body>

</html>
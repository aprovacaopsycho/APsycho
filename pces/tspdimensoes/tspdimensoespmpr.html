<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste TSP Dimensões | Aprovação Psycho</title>
    <link rel="icon" type="image/png" href="../favicon.png" />

    <!-- SEGURANÇA -->
    <script src="../scripts/auth_guard.js"></script>

    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ESTILOS -->
    <style>
        :root {
            --primary: #9f54ff;
            --accent: #ff00ff;
            --bg-dark: #050508;
        }

        body {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 15% 50%, rgba(159, 84, 255, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 194, 255, 0.08), transparent 25%);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        /* Teste Container */
        .test-container {
            position: relative;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-image {
            display: block;
            width: 100%;
            height: auto;
            user-select: none;
        }

        /* Clickable Box */
        .click-box {
            position: absolute;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            /* Debug border: border: 1px solid rgba(255,0,0,0.3); */
        }

        .click-box:hover {
            background-color: rgba(159, 84, 255, 0.2);
            box-shadow: 0 0 10px rgba(159, 84, 255, 0.4);
        }

        /* Marcação X */
        .mark-x {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #ef4444;
            /* Red X */
            font-weight: 900;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        /* Glassmorphism Generic */
        .glass-panel {
            background: rgba(20, 20, 30, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* INAPTO */
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');

        .loser-text {
            font-family: 'Black Ops One', cursive;
            font-size: 3.5rem;
            line-height: 1;
            font-weight: 900;
            color: #ef4444;
            text-transform: uppercase;
            text-align: center;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both infinite;
            margin-bottom: 1rem;
        }

        .shake-screen {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-2px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(4px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-6px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(6px, 0, 0);
            }
        }

        /* Floating XP */
        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        .animate-float-up {
            animation: floatUp 1s ease-out forwards;
        }
    </style>
</head>

<body x-data="tspApp()" x-init="init()" class="min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-black/40 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="../logo-principal.png" alt="Logo" class="h-8">
                <div class="flex flex-col">
                    <span class="text-xl font-black text-gray-200">APROVAÇÃO <span class="text-[var(--accent)]"
                            style="text-shadow:0 0 8px var(--accent)">PSYCHO</span></span>
                    <span class="text-white font-black text-lg leading-none">TSP <span
                            class="text-[var(--primary)]">DIMENSÕES</span></span>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <!-- Timer -->
                <!-- Timer Removed from Header -->
                <div x-show="step === 1 && reviewMode"
                    class="text-green-400 font-black text-lg animate-pulse tracking-widest uppercase border border-green-500/30 px-3 py-1 rounded bg-green-500/10">
                    MODO GABARITO
                </div>

                <a href="../testes_inteligencia.html" @click="return confirm('Sair do teste?')"
                    class="text-sm text-gray-400 hover:text-white flex items-center gap-2 transition">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow flex flex-col items-center justify-center relative">

        <!-- Unified Timer -->
        <div x-show="step === 1" class="fixed top-24 left-1/2 -translate-x-1/2 z-[110] flex items-center gap-4">
            <div class="glass-panel px-6 py-3 rounded-full flex items-center gap-4 shadow-2xl border border-white/20 bg-[#1c1b29]/90 backdrop-blur-md"
                :class="{'border-red-500 bg-red-900/40': timeRemaining <= 10}">
                <div class="text-xs font-bold uppercase tracking-wider text-gray-400">Restante</div>
                <div class="font-mono text-3xl font-black text-white tabular-nums leading-none"
                    :class="{'text-red-400 animate-pulse': timeRemaining <= 10}" x-text="formatTime(timeRemaining)">
                </div>
            </div>
        </div>

        <!-- XP Floats -->
        <div class="fixed inset-0 pointer-events-none z-50">
            <template x-for="xp in xpFloats" :key="xp.id">
                <div class="absolute text-yellow-400 font-black text-2xl animate-float-up"
                    :style="`left: ${xp.x}px; top: ${xp.y}px; text-shadow: 0 0 10px gold;`">
                    +XP
                </div>
            </template>
        </div>

        <!-- INTRO (Step 0) -->
        <div x-show="step === 0" class="glass-panel p-8 rounded-2xl max-w-3xl w-full text-center fade-in">
            <h1 class="text-3xl font-bold text-white mb-6">TSP Dimensões</h1>

            <div class="bg-black/30 p-6 rounded-xl border border-white/5 text-left mb-6">
                <h2 class="text-xl font-bold text-[var(--primary)] mb-4"><i class="fas fa-info-circle mr-2"></i>
                    Instruções</h2>
                <p class="text-gray-300 mb-4">Este teste verifica sua aptidão para percepção espacial.</p>
                <p class="text-white font-bold mb-4">DEVE-SE MARCAR UMA DAS QUATRO FIGURAS QUE ESTÁ INVERTIDA EM RELAÇÃO
                    À DA ESQUERDA.</p>

                <div class="flex justify-center mb-6 bg-white/5 p-4 rounded">
                    <img src="tspdi_exemplo.png" alt="Exemplo TSP" class="max-w-full h-auto rounded shadow-lg">
                </div>

                <ul class="text-sm text-gray-400 space-y-2">
                    <li><i class="fas fa-clock text-blue-400 w-5"></i> Tempo Limite: <strong>5 minutos</strong></li>
                    <li><i class="fas fa-list-ol text-green-400 w-5"></i> Questões: <strong>48 problemas</strong></li>
                    <li><i class="fas fa-check-circle text-orange-400 w-5"></i> Meta Mínima: <strong>33 acertos</strong>
                    </li>
                </ul>
            </div>

            <div class="flex flex-col items-center gap-4">
                <button @click="startTest()"
                    class="px-8 py-3 bg-[var(--primary)] hover:bg-purple-600 text-white font-bold rounded-xl text-lg shadow-[0_0_20px_rgba(159,84,255,0.4)] transition transform hover:scale-105">
                    COMEÇAR TESTE
                </button>
                <button @click="finishTest()" class="text-sm text-gray-500 hover:text-white underline transition">
                    Ver Apenas Resultado
                </button>
            </div>

            <!-- Histórico -->
            <div class="mt-8 pt-8 border-t border-white/10">
                <h3 class="text-sm font-bold text-gray-500 uppercase mb-4">Histórico Recente</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-black/20">
                            <tr>
                                <th class="px-4 py-2">Data</th>
                                <th class="px-4 py-2 text-center">Acertos</th>
                                <th class="px-4 py-2 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <template x-if="history.length === 0">
                                <tr>
                                    <td colspan="3" class="px-4 py-4 text-center text-gray-600">Nenhum teste realizado.
                                    </td>
                                </tr>
                            </template>
                            <template x-for="h in history.slice(0,5)" :key="h.date">
                                <tr class="hover:bg-white/5 transition">
                                    <td class="px-4 py-2 text-gray-400" x-text="h.date"></td>
                                    <td class="px-4 py-2 text-center font-bold text-white" x-text="h.score + '/48'">
                                    </td>
                                    <td class="px-4 py-2 text-center font-bold"
                                        :class="h.status === 'APTO' ? 'text-green-400' : 'text-red-400'"
                                        x-text="h.status"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TEST (Step 1) -->
        <div x-show="step === 1" class="w-full max-w-5xl flex flex-col items-center">

            <!-- Info Bar -->
            <div class="w-full flex justify-between items-center mb-4 px-2">
                <div class="text-gray-400 text-sm font-bold">
                    Página <span x-text="currentPageIndex + 1"></span> de <span x-text="pages.length"></span>
                </div>
                <div x-show="streak > 1" class="text-orange-400 font-bold animate-pulse">
                    <i class="fas fa-fire"></i> Combo: <span x-text="streak"></span>x
                </div>
            </div>

            <!-- Image & Interaction Layer -->
            <div class="test-container bg-white" id="test-wrapper">
                <div class="relative w-full">
                    <!-- Imagem Base -->
                    <img :src="currentPageData.img" class="test-image" id="base-image" alt="Página do Teste">

                    <!-- Hitboxes Overlay -->
                    <template x-for="item in currentPageData.config.items" :key="item.id">
                        <div class="click-box" @click="!reviewMode && handleItemClick(item, $event)"
                            :style="getBoxStyle(item)" :class="{
                                'border-2 border-green-500 bg-green-500/20 shadow-[0_0_15px_rgba(34,197,94,0.4)]': reviewMode && item.t === 1,
                                'border-2 border-red-500 bg-red-500/20': reviewMode && isItemSelected(item) && item.t === 0,
                                'cursor-default': reviewMode,
                                'cursor-pointer hover:bg-[rgba(159,84,255,0.2)]': !reviewMode
                            }">

                            <!-- Marcação visual se selecionado -->
                            <template x-if="isItemSelected(item)">
                                <div class="mark-x"
                                    :class="reviewMode && item.t === 1 ? 'text-green-400' : 'text-red-500'">X</div>
                            </template>

                            <!-- Indicador de Correto (Check) no modo Review -->
                            <template x-if="reviewMode && item.t === 1">
                                <div
                                    class="absolute -top-3 -right-3 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs shadow-lg z-20">
                                    <i class="fas fa-check"></i>
                                </div>
                            </template>

                        </div>
                    </template>
                </div>
            </div>

            <!-- Preload Next -->
            <img x-show="currentPageIndex < pages.length - 1" :src="pages[currentPageIndex + 1]?.img" class="hidden">

            <!-- Controls -->
            <div
                class="mt-6 flex gap-4 w-full justify-between items-center bg-black/40 p-4 rounded-xl border border-white/10 backdrop-blur-sm sticky bottom-4">
                <button @click="prevPage()" :disabled="currentPageIndex === 0"
                    class="px-6 py-2 rounded-lg border border-white/10 text-gray-300 hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed transition">
                    <i class="fas fa-arrow-left mr-2"></i> Anterior
                </button>

                <div class="text-white font-bold text-lg">
                    Questões Respondidas: <span x-text="Object.keys(answers).length"
                        class="text-[var(--primary)]"></span>
                </div>

                <button @click="nextPage()"
                    class="px-6 py-2 rounded-lg text-white font-bold transition transform active:scale-95 shadow-[0_0_15px_rgba(159,84,255,0.3)]"
                    :class="reviewMode ? 'bg-green-600 hover:bg-green-500' : 'bg-[var(--primary)] hover:bg-purple-600'">

                    <span x-show="!reviewMode"
                        x-text="currentPageIndex === pages.length - 1 ? 'FINALIZAR' : 'PRÓXIMA PÁGINA'"></span>
                    <span x-show="reviewMode"
                        x-text="currentPageIndex === pages.length - 1 ? 'VOLTAR AO RESULTADO' : 'PRÓXIMA PÁGINA'"></span>

                    <i class="fas"
                        :class="currentPageIndex === pages.length - 1 ? (reviewMode ? 'fa-undo ml-2' : 'fa-check ml-2') : 'fa-arrow-right ml-2'"></i>
                </button>
            </div>
        </div>

        <!-- RESULTS (Step 2) -->
        <div x-show="step === 2" class="glass-panel p-10 rounded-2xl max-w-3xl w-full text-center fade-in" x-cloak>
            <div class="mb-8">
                <div
                    class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                    <i class="fas fa-flag-checkered text-4xl text-gray-300"></i>
                </div>
                <h2 class="text-4xl font-black text-white mb-2">RESULTADO</h2>
                <p class="text-gray-400">TSP Dimensões</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Score Block -->
                <div class="bg-black/30 p-6 rounded-xl border border-white/5">
                    <div class="text-sm text-gray-500 uppercase tracking-widest mb-2 font-bold">Acertos</div>
                    <div class="text-6xl font-black text-white mb-1" x-text="finalScore"></div>
                    <div class="text-sm text-gray-400">de 48 questões</div>
                </div>

                <!-- Status Block -->
                <div class="bg-black/30 p-6 rounded-xl border border-white/5 flex flex-col justify-center items-center">
                    <template x-if="finalScore >= 33">
                        <div>
                            <div class="text-sm text-green-500 uppercase tracking-widest mb-2 font-bold">Status</div>
                            <div class="text-4xl font-black text-green-400 drop-shadow-[0_0_10px_rgba(74,222,128,0.3)]">
                                APTO</div>
                            <div
                                class="mt-2 px-3 py-1 rounded bg-green-500/10 text-green-300 text-xs font-bold inline-block border border-green-500/20">
                                Aprovado</div>
                        </div>
                    </template>
                    <template x-if="finalScore < 33">
                        <div class="flex flex-col items-center">
                            <div class="loser-text text-3xl">VOCÊ FICOU<br>INAPTO!</div>
                            <div
                                class="px-4 py-1 rounded-full bg-red-500/10 text-red-400 font-bold border border-red-500/30 text-sm">
                                REPROVADO</div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex justify-center gap-4 flex-wrap">
                <button @click="startReview()"
                    class="px-6 py-3 rounded-xl bg-yellow-500/10 text-yellow-500 hover:bg-yellow-500/20 transition font-bold border border-yellow-500/30">
                    <i class="fas fa-eye mr-2"></i> Conferir Gabarito
                </button>
                <a href="../testes_inteligencia.html"
                    class="px-6 py-3 rounded-xl border border-white/10 text-gray-400 hover:text-white hover:bg-white/5 transition">
                    Voltar ao Menu
                </a>
                <button @click="location.reload()"
                    class="px-6 py-3 rounded-xl bg-white/10 text-white hover:bg-white/20 transition font-bold border border-white/10">
                    <i class="fas fa-redo mr-2"></i> Tentar Novamente
                </button>
            </div>

        </div>

    </main>

    <script>
        // CONFIGURAÇÃO DOS ITENS (INJETADA)
        // Página 1 (Items 0 a 95 -> 24 Questões de 4 opções) | IDs 0-95
        const CONFIG_PAGE_1 = { "imgWidth": 793, "imgHeight": 1013, "boxW": 50, "boxH": 50, "items": [{ "id": 0, "x": 105, "y": 47, "t": 0 }, { "id": 1, "x": 180, "y": 47, "t": 0 }, { "id": 2, "x": 253, "y": 47, "t": 1 }, { "id": 3, "x": 326, "y": 47, "t": 0 }, { "id": 4, "x": 509, "y": 47, "t": 0 }, { "id": 5, "x": 576, "y": 47, "t": 1 }, { "id": 6, "x": 651, "y": 47, "t": 0 }, { "id": 7, "x": 723, "y": 47, "t": 0 }, { "id": 8, "x": 105, "y": 123, "t": 1 }, { "id": 9, "x": 180, "y": 123, "t": 0 }, { "id": 10, "x": 253, "y": 123, "t": 0 }, { "id": 11, "x": 326, "y": 123, "t": 0 }, { "id": 12, "x": 509, "y": 123, "t": 0 }, { "id": 13, "x": 576, "y": 123, "t": 0 }, { "id": 14, "x": 651, "y": 123, "t": 0 }, { "id": 15, "x": 723, "y": 123, "t": 1 }, { "id": 16, "x": 105, "y": 207, "t": 0 }, { "id": 17, "x": 180, "y": 207, "t": 0 }, { "id": 18, "x": 253, "y": 207, "t": 0 }, { "id": 19, "x": 326, "y": 207, "t": 1 }, { "id": 20, "x": 509, "y": 207, "t": 0 }, { "id": 21, "x": 576, "y": 207, "t": 1 }, { "id": 22, "x": 651, "y": 207, "t": 0 }, { "id": 23, "x": 723, "y": 207, "t": 0 }, { "id": 24, "x": 105, "y": 285, "t": 0 }, { "id": 25, "x": 180, "y": 285, "t": 0 }, { "id": 26, "x": 253, "y": 285, "t": 1 }, { "id": 27, "x": 326, "y": 285, "t": 0 }, { "id": 28, "x": 509, "y": 285, "t": 0 }, { "id": 29, "x": 576, "y": 285, "t": 1 }, { "id": 30, "x": 651, "y": 285, "t": 0 }, { "id": 31, "x": 723, "y": 285, "t": 0 }, { "id": 32, "x": 105, "y": 363, "t": 0 }, { "id": 33, "x": 180, "y": 363, "t": 1 }, { "id": 34, "x": 253, "y": 363, "t": 0 }, { "id": 35, "x": 326, "y": 363, "t": 0 }, { "id": 36, "x": 509, "y": 363, "t": 1 }, { "id": 37, "x": 576, "y": 363, "t": 0 }, { "id": 38, "x": 651, "y": 363, "t": 0 }, { "id": 39, "x": 723, "y": 363, "t": 0 }, { "id": 40, "x": 105, "y": 443, "t": 0 }, { "id": 41, "x": 180, "y": 443, "t": 0 }, { "id": 42, "x": 253, "y": 443, "t": 0 }, { "id": 43, "x": 326, "y": 443, "t": 1 }, { "id": 44, "x": 509, "y": 443, "t": 0 }, { "id": 45, "x": 576, "y": 443, "t": 0 }, { "id": 46, "x": 651, "y": 443, "t": 1 }, { "id": 47, "x": 723, "y": 443, "t": 0 }, { "id": 48, "x": 105, "y": 522, "t": 1 }, { "id": 49, "x": 180, "y": 522, "t": 0 }, { "id": 50, "x": 253, "y": 522, "t": 0 }, { "id": 51, "x": 326, "y": 522, "t": 0 }, { "id": 52, "x": 509, "y": 522, "t": 0 }, { "id": 53, "x": 576, "y": 522, "t": 0 }, { "id": 54, "x": 651, "y": 522, "t": 0 }, { "id": 55, "x": 723, "y": 522, "t": 1 }, { "id": 56, "x": 105, "y": 603, "t": 1 }, { "id": 57, "x": 180, "y": 603, "t": 0 }, { "id": 58, "x": 253, "y": 603, "t": 0 }, { "id": 59, "x": 326, "y": 603, "t": 0 }, { "id": 60, "x": 509, "y": 603, "t": 0 }, { "id": 61, "x": 576, "y": 603, "t": 0 }, { "id": 62, "x": 651, "y": 603, "t": 1 }, { "id": 63, "x": 723, "y": 603, "t": 0 }, { "id": 64, "x": 105, "y": 684, "t": 0 }, { "id": 65, "x": 180, "y": 684, "t": 1 }, { "id": 66, "x": 253, "y": 684, "t": 0 }, { "id": 67, "x": 326, "y": 684, "t": 0 }, { "id": 68, "x": 509, "y": 684, "t": 0 }, { "id": 69, "x": 576, "y": 684, "t": 1 }, { "id": 70, "x": 651, "y": 684, "t": 0 }, { "id": 71, "x": 723, "y": 684, "t": 0 }, { "id": 72, "x": 105, "y": 762, "t": 0 }, { "id": 73, "x": 180, "y": 762, "t": 0 }, { "id": 74, "x": 253, "y": 762, "t": 1 }, { "id": 75, "x": 326, "y": 762, "t": 0 }, { "id": 76, "x": 509, "y": 762, "t": 1 }, { "id": 77, "x": 576, "y": 762, "t": 0 }, { "id": 78, "x": 651, "y": 762, "t": 0 }, { "id": 79, "x": 723, "y": 762, "t": 0 }, { "id": 80, "x": 105, "y": 846, "t": 0 }, { "id": 81, "x": 180, "y": 846, "t": 1 }, { "id": 82, "x": 253, "y": 846, "t": 0 }, { "id": 83, "x": 326, "y": 846, "t": 0 }, { "id": 84, "x": 509, "y": 846, "t": 0 }, { "id": 85, "x": 576, "y": 846, "t": 0 }, { "id": 86, "x": 651, "y": 846, "t": 0 }, { "id": 87, "x": 723, "y": 846, "t": 1 }, { "id": 88, "x": 105, "y": 922, "t": 0 }, { "id": 89, "x": 180, "y": 922, "t": 0 }, { "id": 90, "x": 253, "y": 922, "t": 0 }, { "id": 91, "x": 326, "y": 922, "t": 1 }, { "id": 92, "x": 509, "y": 922, "t": 0 }, { "id": 93, "x": 576, "y": 922, "t": 0 }, { "id": 94, "x": 651, "y": 922, "t": 1 }, { "id": 95, "x": 723, "y": 922, "t": 0 }] };

        // Página 2 (Questões 25 a 48) | IDs 0-95 (mapeados para questões globais 24-47 internamente)
        const CONFIG_PAGE_2 = { "imgWidth": 793, "imgHeight": 1013, "boxW": 50, "boxH": 50, "items": [{ "id": 0, "x": 107, "y": 51, "t": 0 }, { "id": 1, "x": 177, "y": 51, "t": 0 }, { "id": 2, "x": 249, "y": 51, "t": 0 }, { "id": 3, "x": 323, "y": 51, "t": 1 }, { "id": 4, "x": 507, "y": 51, "t": 0 }, { "id": 5, "x": 577, "y": 51, "t": 0 }, { "id": 6, "x": 647, "y": 51, "t": 1 }, { "id": 7, "x": 718, "y": 51, "t": 0 }, { "id": 8, "x": 107, "y": 126, "t": 0 }, { "id": 9, "x": 177, "y": 126, "t": 1 }, { "id": 10, "x": 249, "y": 126, "t": 0 }, { "id": 11, "x": 323, "y": 126, "t": 0 }, { "id": 12, "x": 507, "y": 126, "t": 0 }, { "id": 13, "x": 577, "y": 126, "t": 0 }, { "id": 14, "x": 647, "y": 126, "t": 0 }, { "id": 15, "x": 718, "y": 126, "t": 1 }, { "id": 16, "x": 107, "y": 208, "t": 0 }, { "id": 17, "x": 177, "y": 208, "t": 0 }, { "id": 18, "x": 249, "y": 208, "t": 1 }, { "id": 19, "x": 323, "y": 208, "t": 0 }, { "id": 20, "x": 507, "y": 208, "t": 1 }, { "id": 21, "x": 577, "y": 208, "t": 0 }, { "id": 22, "x": 647, "y": 208, "t": 0 }, { "id": 23, "x": 718, "y": 208, "t": 0 }, { "id": 24, "x": 107, "y": 291, "t": 0 }, { "id": 25, "x": 177, "y": 291, "t": 1 }, { "id": 26, "x": 249, "y": 291, "t": 0 }, { "id": 27, "x": 323, "y": 291, "t": 0 }, { "id": 28, "x": 507, "y": 291, "t": 0 }, { "id": 29, "x": 577, "y": 291, "t": 1 }, { "id": 30, "x": 647, "y": 291, "t": 0 }, { "id": 31, "x": 718, "y": 291, "t": 0 }, { "id": 32, "x": 107, "y": 369, "t": 1 }, { "id": 33, "x": 177, "y": 369, "t": 0 }, { "id": 34, "x": 249, "y": 369, "t": 0 }, { "id": 35, "x": 323, "y": 369, "t": 0 }, { "id": 36, "x": 507, "y": 369, "t": 0 }, { "id": 37, "x": 577, "y": 369, "t": 0 }, { "id": 38, "x": 647, "y": 369, "t": 1 }, { "id": 39, "x": 718, "y": 369, "t": 0 }, { "id": 40, "x": 107, "y": 448, "t": 1 }, { "id": 41, "x": 177, "y": 448, "t": 0 }, { "id": 42, "x": 249, "y": 448, "t": 0 }, { "id": 43, "x": 323, "y": 448, "t": 0 }, { "id": 44, "x": 507, "y": 448, "t": 0 }, { "id": 45, "x": 577, "y": 448, "t": 0 }, { "id": 46, "x": 647, "y": 448, "t": 0 }, { "id": 47, "x": 718, "y": 448, "t": 1 }, { "id": 48, "x": 107, "y": 529, "t": 0 }, { "id": 49, "x": 177, "y": 529, "t": 0 }, { "id": 50, "x": 249, "y": 529, "t": 0 }, { "id": 51, "x": 323, "y": 529, "t": 1 }, { "id": 52, "x": 507, "y": 529, "t": 0 }, { "id": 53, "x": 577, "y": 529, "t": 0 }, { "id": 54, "x": 647, "y": 529, "t": 1 }, { "id": 55, "x": 718, "y": 529, "t": 0 }, { "id": 56, "x": 107, "y": 609, "t": 0 }, { "id": 57, "x": 177, "y": 609, "t": 1 }, { "id": 58, "x": 249, "y": 609, "t": 0 }, { "id": 59, "x": 323, "y": 609, "t": 0 }, { "id": 60, "x": 507, "y": 609, "t": 1 }, { "id": 61, "x": 577, "y": 609, "t": 0 }, { "id": 62, "x": 647, "y": 609, "t": 0 }, { "id": 63, "x": 718, "y": 609, "t": 0 }, { "id": 64, "x": 107, "y": 688, "t": 0 }, { "id": 65, "x": 177, "y": 688, "t": 0 }, { "id": 66, "x": 250, "y": 692, "t": 0 }, { "id": 67, "x": 323, "y": 688, "t": 0 }, { "id": 68, "x": 507, "y": 688, "t": 0 }, { "id": 69, "x": 577, "y": 688, "t": 1 }, { "id": 70, "x": 647, "y": 688, "t": 0 }, { "id": 71, "x": 718, "y": 688, "t": 0 }, { "id": 72, "x": 107, "y": 765, "t": 0 }, { "id": 73, "x": 177, "y": 765, "t": 0 }, { "id": 74, "x": 249, "y": 765, "t": 0 }, { "id": 75, "x": 323, "y": 766, "t": 1 }, { "id": 76, "x": 507, "y": 765, "t": 0 }, { "id": 77, "x": 577, "y": 765, "t": 1 }, { "id": 78, "x": 647, "y": 765, "t": 0 }, { "id": 79, "x": 718, "y": 765, "t": 0 }, { "id": 80, "x": 107, "y": 849, "t": 1 }, { "id": 81, "x": 177, "y": 849, "t": 0 }, { "id": 82, "x": 249, "y": 849, "t": 0 }, { "id": 83, "x": 323, "y": 849, "t": 0 }, { "id": 84, "x": 507, "y": 849, "t": 0 }, { "id": 85, "x": 577, "y": 849, "t": 0 }, { "id": 86, "x": 647, "y": 849, "t": 0 }, { "id": 87, "x": 718, "y": 849, "t": 1 }, { "id": 88, "x": 107, "y": 930, "t": 0 }, { "id": 89, "x": 177, "y": 930, "t": 0 }, { "id": 90, "x": 249, "y": 930, "t": 1 }, { "id": 91, "x": 323, "y": 930, "t": 0 }, { "id": 92, "x": 507, "y": 930, "t": 1 }, { "id": 93, "x": 577, "y": 930, "t": 0 }, { "id": 94, "x": 647, "y": 930, "t": 0 }, { "id": 95, "x": 718, "y": 930, "t": 0 }] };

        function tspApp() {
            return {
                step: 0, // 0=Intro, 1=Test, 2=Results
                pages: [
                    { img: 'tsp_dimensoes_Page3.png', config: CONFIG_PAGE_1 },
                    { img: 'tsp_dimensoes_Page4.png', config: CONFIG_PAGE_2 }
                ],
                currentPageIndex: 0,
                timeRemaining: 300, // 5 min
                timerInterval: null,

                answers: {}, // Key: "pageIndex_questionIndex", Value: itemID

                scale: 1,

                streak: 0,
                xpFloats: [],
                history: [],

                finalScore: 0,
                reviewMode: false,

                get currentPageData() {
                    return this.pages[this.currentPageIndex];
                },

                init() {
                    this.loadHistory();

                    // Responsive Scaling
                    window.addEventListener('resize', () => this.updateScale());
                    // Wait for image load to scale
                    setInterval(() => this.updateScale(), 1000);
                },

                updateScale() {
                    const img = document.getElementById('base-image');
                    if (img && img.naturalWidth > 0) {
                        this.scale = img.width / img.naturalWidth;
                    }
                },

                startTest() {
                    this.step = 1;
                    this.currentPageIndex = 0;
                    this.timeRemaining = 300;
                    this.answers = {};
                    this.streak = 0;

                    this.timerInterval = setInterval(() => {
                        this.timeRemaining--;
                        if (this.timeRemaining <= 0) this.finishTest();
                    }, 1000);

                    // Wait for image render
                    setTimeout(() => this.updateScale(), 100);
                },

                startReview() {
                    this.reviewMode = true;
                    this.step = 1;
                    this.currentPageIndex = 0;
                    setTimeout(() => this.updateScale(), 100);
                },

                handleItemClick(item, event) {
                    if (this.step !== 1) return;

                    // Determine question index within the page (0-23)
                    const questionLocalIndex = Math.floor(item.id / 4);
                    const globalQuestionID = `${this.currentPageIndex}_${questionLocalIndex}`;

                    // Se já respondeu essa questão, pode alterar? Sim, apenas atualiza.
                    const isNewAnswer = !this.answers[globalQuestionID];

                    // Lógica de Streak / XP (Simplificada: ganha XP se marcar algo novo, não julga imediatamente visualmente para não dar cola, mas computa streak internamente se quiser.
                    // Porém instruções dizem: "A resposta que o examinando considerar correta será marcada com X"
                    // Vamos apenas marcar. O feedback é só no final? Ou imediato?
                    // R1 tem feedback imediato (verde/vermelho).
                    // Para esse teste, geralmente é papel e caneta, sem feedback.
                    // Mas o usuário gosta de gamificação.
                    // VAMOS DAR FEEDBACK VISUAL APENAS NO FINAL?
                    // "Mantenha o layout e todas as funcionalidades que as minhas outras páginas tem."
                    // As outras páginas (R1, Beta3) dão feedback imediato e XP.
                    // Então vou dar feedback IMEDIATO.

                    if (this.answers[globalQuestionID] === item.id) return; // Já marcado esse item

                    this.answers[globalQuestionID] = item.id;

                    // Feedback Imediato
                    if (item.t === 1) {
                        // Acertou
                        this.streak++;
                        this.spawnXP(event.clientX, event.clientY);
                    } else {
                        // Errou
                        this.streak = 0;
                        // Shake effect on container?
                        // document.getElementById('test-wrapper').classList.add('animate-shake'); // simplificando
                    }

                    // Força update do X
                    this.answers = { ...this.answers };
                },

                isItemSelected(item) {
                    const questionLocalIndex = Math.floor(item.id / 4);
                    const globalQuestionID = `${this.currentPageIndex}_${questionLocalIndex}`;
                    return this.answers[globalQuestionID] === item.id;
                },

                getBoxStyle(item) {
                    // Coordinates are based on original image dimensions
                    // Need to scale them
                    const x = item.x * this.scale;
                    const y = item.y * this.scale;
                    const w = this.currentPageData.config.boxW * this.scale;
                    const h = this.currentPageData.config.boxH * this.scale;

                    return `
                        left: ${x}px;
                        top: ${y}px;
                        width: ${w}px;
                        height: ${h}px;
                    `;
                },

                prevPage() {
                    if (this.currentPageIndex > 0) {
                        this.currentPageIndex--;
                        setTimeout(() => this.updateScale(), 50);
                    }
                },

                nextPage() {
                    if (this.currentPageIndex < this.pages.length - 1) {
                        this.currentPageIndex++;
                        setTimeout(() => this.updateScale(), 50);
                    } else {
                        if (this.reviewMode) {
                            this.step = 2;
                            this.reviewMode = false;
                        } else {
                            this.finishTest();
                        }
                    }
                },

                spawnXP(x, y) {
                    const id = Date.now();
                    this.xpFloats.push({ id, x, y });
                    setTimeout(() => this.xpFloats = this.xpFloats.filter(f => f.id !== id), 1000);
                },

                finishTest() {
                    clearInterval(this.timerInterval);
                    this.step = 2;
                    window.scrollTo(0, 0);

                    // Calcular Score
                    let rawScore = 0;
                    // Loop over all answers
                    // answers keys are "pageIndex_questionLocalIndex"
                    // Need to verify against config
                    for (let key in this.answers) {
                        const [pIndex, qIndex] = key.split('_').map(Number);
                        const itemID = this.answers[key];

                        // Encontrar o item na config da página correta
                        const pageConfig = this.pages[pIndex].config;
                        const item = pageConfig.items.find(i => i.id === itemID);

                        if (item && item.t === 1) {
                            rawScore++;
                        }
                    }
                    this.finalScore = rawScore;
                    this.saveHistory();

                    if (this.finalScore >= 40) { // arbitrary high score for confetti
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    }
                },

                loadHistory() {
                    const h = localStorage.getItem('tspdim_history');
                    if (h) this.history = JSON.parse(h);
                },

                saveHistory() {
                    const status = this.finalScore >= 33 ? "APTO" : "INAPTO";
                    const newEntry = {
                        date: new Date().toLocaleString(),
                        score: this.finalScore,
                        status: status
                    };
                    this.history.unshift(newEntry);
                    localStorage.setItem('tspdim_history', JSON.stringify(this.history));
                },

                formatTime(seconds) {
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                }
            }
        }
    </script>
</body>

</html>
